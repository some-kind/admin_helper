#####################################################################
###                                                               ###
###           Разворачивание PostgreSQL в контейнере              ###
###                                                               ###
#####################################################################
---
- name: "Разворачивание PostgreSQL в docker контейнере"
  #strategy: free
  #serial: "80%"
  hosts: docker_postgres
  become: true
  gather_facts: true
  gather_subset: all

  vars:
    docker_edition: 'ce'
    docker_packages:
      - "docker-{{ docker_edition }}"
      - "docker-{{ docker_edition }}-cli"
      - "docker-{{ docker_edition }}-rootless-extras"
    docker_packages_state: present
    docker_install_compose_plugin: true
    docker_install_compose: false
    docker_compose_package: docker-compose-plugin
    docker_compose_package_state: present
    docker_add_repo: true
    docker_users:
      - "{{ ansible_user }}"

  roles:
    - geerlingguy.docker
    - docker_postgresql

- name: "Проверка работоспособности PostgreSQL"
  hosts: docker_postgres
  become: true
  gather_facts: true

  tasks:
    - name: "Проверка версии"
      postgresql_query:
        query: SELECT version()
        login_host: "{{ ansible_default_ipv4.address }}"
        login_user: postgres
        login_password: postgres
        port: 5432
      become: true
      become_user: postgres